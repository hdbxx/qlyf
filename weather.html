<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>简易天气查询</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind自定义颜色和字体 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#F59E0B',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .weather-card {
        @apply bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl;
      }
      .input-field {
        @apply w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all;
      }
      .btn {
        @apply px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
      }
      .btn-primary {
        @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans text-gray-800">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- 页面标题 -->
    <header class="text-center mb-10">
      <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-dark mb-2 tracking-tight">
        <i class="fa fa-cloud text-primary mr-3"></i>天气查询
      </h1>
      <p class="text-gray-600 text-lg max-w-2xl mx-auto">
        输入城市名称，获取最新天气信息
      </p>
    </header>
    
    <!-- 主内容区 -->
    <main>
      <!-- 查询表单 -->
      <section class="bg-white rounded-2xl shadow-xl p-6 mb-8 transform transition-all duration-500 hover:shadow-2xl">
        <form id="weatherForm" class="flex flex-col md:flex-row gap-4">
          <div class="flex-1">
            <label for="city" class="block text-sm font-medium text-gray-700 mb-1">城市名称</label>
            <input 
              type="text" 
              id="city" 
              class="input-field" 
              placeholder="例如：北京、上海" 
              required
            >
          </div>
          <div class="flex items-end">
            <button type="submit" class="btn btn-primary w-full md:w-auto">
              <i class="fa fa-search mr-2"></i>查询天气
            </button>
          </div>
        </form>
      </section>
      
      <!-- 加载状态 -->
      <div id="loading" class="hidden text-center py-10">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
        <p class="mt-4 text-gray-600">正在获取天气信息...</p>
      </div>
      
      <!-- 错误提示 -->
      <div id="error" class="hidden weather-card bg-red-50 border border-red-100 mb-8">
        <div class="flex items-start">
          <i class="fa fa-exclamation-circle text-red-500 text-xl mt-1 mr-3"></i>
          <div>
            <h3 class="font-medium text-red-800">查询失败</h3>
            <p id="errorMessage" class="text-red-700 mt-1">无法获取天气信息，请稍后再试。</p>
          </div>
        </div>
      </div>
      
      <!-- 天气信息展示 -->
      <section id="weatherResult" class="hidden">
        <div class="weather-card mb-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
              <h2 id="resultCity" class="text-2xl font-bold"></h2>
              <p id="resultDate" class="text-gray-500"></p>
            </div>
            <div class="flex items-center mt-4 md:mt-0">
              <img id="weatherIcon" src="" alt="天气图标" class="w-16 h-16 mr-3">
              <span id="weatherCondition" class="text-xl font-medium"></span>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center">
              <p class="text-gray-500 text-sm mb-1">温度</p>
              <p id="temperature" class="text-xl font-bold text-primary"></p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center">
              <p class="text-gray-500 text-sm mb-1">湿度</p>
              <p id="humidity" class="text-xl font-bold text-green-600"></p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center">
              <p class="text-gray-500 text-sm mb-1">风向</p>
              <p id="windDir" class="text-xl font-bold text-yellow-600"></p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg text-center">
              <p class="text-gray-500 text-sm mb-1">风力</p>
              <p id="windScale" class="text-xl font-bold text-purple-600"></p>
            </div>
          </div>
          
          <div class="text-sm text-gray-500 italic">
            <p>数据更新时间: <span id="updateTime"></span></p>
          </div>
        </div>
        
        <div class="text-center text-gray-500 text-sm">
          <p>最近查询的天气信息将保存在您的浏览器中</p>
        </div>
      </section>
      
      <!-- 没有数据提示 -->
      <div id="noData" class="weather-card text-center py-10">
        <i class="fa fa-search text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">请输入城市名称查询天气</p>
      </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="mt-16 text-center text-gray-500 text-sm">
      <p>&copy; 2023 简易天气查询 | 数据来源: 和风天气</p>
    </footer>
  </div>

  <script>
    // API密钥 - 请替换为您自己的和风天气API密钥
    const API_KEY = '6c468480cc4e455f9a3930212f5224f5';
    const API_URL = 'https://devapi.qweather.com/v7/weather/now';
    
    // DOM元素
    const weatherForm = document.getElementById('weatherForm');
    const cityInput = document.getElementById('city');
    const weatherResult = document.getElementById('weatherResult');
    const weatherIcon = document.getElementById('weatherIcon');
    const resultCity = document.getElementById('resultCity');
    const resultDate = document.getElementById('resultDate');
    const weatherCondition = document.getElementById('weatherCondition');
    const temperature = document.getElementById('temperature');
    const humidity = document.getElementById('humidity');
    const windDir = document.getElementById('windDir');
    const windScale = document.getElementById('windScale');
    const updateTime = document.getElementById('updateTime');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const errorMessage = document.getElementById('errorMessage');
    const noData = document.getElementById('noData');
    
    // 页面加载时检查Cookie中的天气数据
    document.addEventListener('DOMContentLoaded', () => {
      const savedWeather = getCookie('lastWeather');
      if (savedWeather) {
        try {
          const weatherData = JSON.parse(savedWeather);
          displayWeather(weatherData);
        } catch (e) {
          console.error('Failed to parse saved weather data', e);
          showNoData();
        }
      } else {
        showNoData();
      }
    });
    
    // 表单提交事件
    weatherForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const city = cityInput.value.trim();
      
      if (!city) return;
      
      try {
        showLoading();
        hideError();
        
        // 先通过城市名获取LocationID
        const locationId = await getLocationId(city);
        if (!locationId) {
          throw new Error('未找到该城市，请检查城市名称是否正确');
        }
        
        // 获取天气数据
        const weatherData = await fetchWeatherData(locationId);
        if (weatherData) {
          // 保存到Cookie
          setCookie('lastWeather', JSON.stringify(weatherData), 1);
          // 显示天气信息
          displayWeather(weatherData);
        }
      } catch (err) {
        showError(err.message || '获取天气信息失败，请稍后再试');
      } finally {
        hideLoading();
        cityInput.value = '';
      }
    });
    
    // 获取城市LocationID
    async function getLocationId(city) {
      try {
        const response = await fetch(`https://geoapi.qweather.com/v2/city/lookup?location=${encodeURIComponent(city)}&key=${API_KEY}`);
        const data = await response.json();
        
        if (data.code !== '200' || data.location.length === 0) {
          return null;
        }
        
        return data.location[0].id;
      } catch (err) {
        console.error('获取城市ID失败', err);
        throw new Error('获取城市信息失败');
      }
    }
    
    // 获取天气数据
    async function fetchWeatherData(locationId) {
      try {
        const response = await fetch(`${API_URL}?location=${locationId}&key=${API_KEY}`);
        const data = await response.json();
        
        if (data.code !== '200') {
          throw new Error(`获取天气信息失败: ${data.code}`);
        }
        
        // 获取城市信息
        //const cityInfo = await getCityInfo(locationId);
        console.log(cityInput.value)
        let cityInfo={
            name:cityInput.value,
            country:"中国",
            adm1:""
        }
        return {
          city: cityInfo.name,
          province: cityInfo.adm1,
          country: cityInfo.country,
          weather: data.now.text,
          temp: data.now.temp,
          humidity: data.now.humidity,
          windDir: data.now.windDir,
          windScale: data.now.windScale,
          icon: data.now.icon,
          updateTime: data.updateTime,
          timestamp: new Date().getTime()
        };
      } catch (err) {
        console.error('获取天气数据失败', err);
        throw err;
      }
    }
    
    // 获取城市详细信息
    async function getCityInfo(locationId) {
      try {
        const response = await fetch(`https://geoapi.qweather.com/v2/city/info?location=${locationId}&key=${API_KEY}`);
        const data = await response.json();
        
        if (data.code !== '200') {
          return { name: '未知城市', adm1: '', country: '' };
        }
        
        return data.location;
      } catch (err) {
        console.error('获取城市信息失败', err);
        return { name: '未知城市', adm1: '', country: '' };
      }
    }
    
    // 显示天气信息
    function displayWeather(data) {
      // 构建城市名称（包含省份和国家）
      let fullCityName = data.city;
      if (data.province && data.province !== data.city) {
        fullCityName = `${data.province} ${fullCityName}`;
      }
      if (data.country && data.country !== '中国') {
        fullCityName += `, ${data.country}`;
      }
      
      // 格式化日期
      const date = new Date(data.timestamp);
      const formattedDate = date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      
      // 更新UI
      resultCity.textContent = fullCityName;
      resultDate.textContent = formattedDate;
      weatherCondition.textContent = data.weather;
      temperature.textContent = `${data.temp}°C`;
      humidity.textContent = `${data.humidity}%`;
      windDir.textContent = data.windDir;
      windScale.textContent = `${data.windScale}级`;
      
      // 格式化更新时间
      const updateDate = new Date(data.updateTime);
      updateTime.textContent = updateDate.toLocaleString('zh-CN');
      
      // 设置天气图标
      weatherIcon.src = `https://cdn.qweather.com/icons/cond_icon/${data.icon}.svg`;
      weatherIcon.alt = data.weather;
      
      // 显示结果，隐藏其他状态
      showWeatherResult();
      //hideNoData();
    }
    
    // Cookie操作函数
    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      const expires = `expires=${date.toUTCString()}`;
      document.cookie = `${name}=${encodeURIComponent(value)}; ${expires}; path=/`;
    }
    
    function getCookie(name) {
      const nameEQ = `${name}=`;
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
      }
      return null;
    }
    
    // 显示/隐藏状态函数
    function showLoading() {
      loading.classList.remove('hidden');
      weatherResult.classList.add('hidden');
      noData.classList.add('hidden');
    }
    
    function hideLoading() {
      loading.classList.add('hidden');
    }
    
    function showError(message) {
      errorMessage.textContent = message;
      error.classList.remove('hidden');
      weatherResult.classList.add('hidden');
      noData.classList.add('hidden');
    }
    
    function hideError() {
      error.classList.add('hidden');
    }
    
    function showWeatherResult() {
      weatherResult.classList.remove('hidden');
      error.classList.add('hidden');
      noData.classList.add('hidden');
    }
    
    function showNoData() {
      noData.classList.remove('hidden');
      weatherResult.classList.add('hidden');
      error.classList.add('hidden');
    }
  </script>
</body>
</html>